import React, { useState, useEffect, useRef } from 'react';
import { 
  Sparkles, X, Copy, Share2, MoreHorizontal, ChevronLeft, ChevronRight, 
  Search, Lock, Zap, Sidebar, FileText, Code, Youtube, MessageSquare, 
  ArrowRight, Globe, Layers, Command, TrendingUp, AlertTriangle, 
  Activity, Play, Pause, Volume2, Maximize, Bug, TestTube, CheckCircle2,
  Cpu, Wallet, ShoppingCart, ListChecks, GraduationCap, Tag, ThumbsUp, Scale,
  Plus, RotateCw, LayoutGrid, UserCircle, BookOpen, History, Settings,
  BarChart3, Box, ExternalLink, PenTool, Lightbulb, Share, Pin, PinOff,
  Wand2, Puzzle, Star, MoreVertical, Home, PanelRight, Folder, ThumbsDown,
  MonitorPlay, ListVideo, Subtitles, Check
} from 'lucide-react';

// --- 1. é™æ€æ•°æ®ä¸æ ·å¼å®šä¹‰ ---

const CHROME_COLORS = {
  frame: 'bg-[#dee1e6]',
  toolbar: 'bg-white',
  tabActive: 'bg-white',
  tabInactive: 'hover:bg-[#e7eaed]',
  omnibox: 'bg-[#f1f3f4]',
  text: 'text-[#3c4043]',
  textSecondary: 'text-[#5f6368]',
  separator: 'bg-[#80868b]',
};

const THEME_STYLES = {
  rose: { text: 'text-rose-600', ring: 'focus-within:ring-rose-200', glow: 'shadow-rose-500/20', iconBg: 'bg-rose-100', pillBg: 'bg-rose-50/80', pillBorder: 'border-rose-200', activeIcon: 'text-rose-600', badge: 'bg-rose-50 text-rose-600' },
  emerald: { text: 'text-emerald-600', ring: 'focus-within:ring-emerald-200', glow: 'shadow-emerald-500/20', iconBg: 'bg-emerald-100', pillBg: 'bg-emerald-50/80', pillBorder: 'border-emerald-200', activeIcon: 'text-emerald-600', badge: 'bg-emerald-50 text-emerald-600' },
  amber: { text: 'text-amber-600', ring: 'focus-within:ring-amber-200', glow: 'shadow-amber-500/20', iconBg: 'bg-amber-100', pillBg: 'bg-amber-50/80', pillBorder: 'border-amber-200', activeIcon: 'text-amber-600', badge: 'bg-amber-50 text-amber-600' },
  indigo: { text: 'text-indigo-600', ring: 'focus-within:ring-indigo-200', glow: 'shadow-indigo-500/20', iconBg: 'bg-indigo-100', pillBg: 'bg-indigo-50/80', pillBorder: 'border-indigo-200', activeIcon: 'text-indigo-600', badge: 'bg-indigo-50 text-indigo-600' },
  purple: { text: 'text-purple-600', ring: 'focus-within:ring-purple-200', glow: 'shadow-purple-500/20', iconBg: 'bg-purple-100', pillBg: 'bg-purple-50/80', pillBorder: 'border-purple-200', activeIcon: 'text-purple-600', badge: 'bg-purple-50 text-purple-600' },
  red: { text: 'text-red-600', ring: 'focus-within:ring-red-200', glow: 'shadow-red-500/20', iconBg: 'bg-red-100', pillBg: 'bg-red-50/80', pillBorder: 'border-red-200', activeIcon: 'text-red-600', badge: 'bg-red-50 text-red-600' },
};

// é¡µé¢å†…å®¹åŒºåŸŸçš„é¢œè‰²é…ç½®
const CONTENT_COLORS = {
  indigo: 'text-indigo-600 bg-indigo-50',
  rose: 'text-rose-600 bg-rose-50',
  emerald: 'text-emerald-600 bg-emerald-50',
  amber: 'text-amber-600 bg-amber-50',
  purple: 'text-purple-600 bg-purple-50',
  red: 'text-red-600 bg-red-50',
};

const INITIAL_TABS = [
  { 
    id: 'tab-5', 
    type: 'design', 
    title: 'è®¾è®¡ç†å¿µ - Liquid Intelligence', 
    url: 'design.ai-browser.com/manifesto',
    icon: PenTool,
    theme: 'indigo'
  },
  { 
    id: 'tab-1', 
    type: 'shopping', 
    title: 'Sony WH-1000XM5 - å®˜æ–¹æ——èˆ°åº—', 
    url: 'store.sony.com/products/wh-1000xm5',
    icon: ShoppingCart,
    theme: 'rose'
  },
  { 
    id: 'tab-6', 
    type: 'video', 
    title: 'AI æµè§ˆå™¨çš„æœªæ¥ - YouTube', 
    url: 'youtube.com/watch?v=ai-browser-demo',
    icon: Youtube,
    theme: 'red'
  },
  { 
    id: 'tab-3', 
    type: 'code', 
    title: 'payment_logic.ts - GitHub', 
    url: 'github.com/stripe/payment-gateway/blob/main/logic.ts',
    icon: Code,
    theme: 'amber'
  },
  { 
    id: 'tab-2', 
    type: 'finance', 
    title: 'è‹±ä¼Ÿè¾¾ (NVDA) - ç¾è‚¡è¡Œæƒ…', 
    url: 'marketwatch.com/investing/stock/nvda',
    icon: TrendingUp,
    theme: 'emerald'
  }
];

const BOOKMARKS = [
  { title: "Gmail", icon: null },
  { title: "YouTube", icon: null },
  { title: "Maps", icon: null },
  { title: "GitHub - Dashboard", icon: Code },
  { title: "Figma", icon: PenTool },
  { title: "Notion", icon: FileText },
];

// --- è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆ 2-6ç§’ éšæœºå»¶è¿Ÿ ---
const getRandomDelay = () => {
  const min = 2000;
  const max = 6000;
  return Math.floor(Math.random() * (max - min + 1) + min);
};

// --- 2. æ¨¡æ‹Ÿ AI é€»è¾‘ ---
const getAiSuggestions = (pageContent) => {
  const suggestions = [];
  const type = pageContent?.type || 'design';

  switch (type) {
    case 'shopping':
      suggestions.push({ id: 'price_check', label: 'å…¨ç½‘æ¯”ä»·', icon: Tag, color: 'text-rose-600' });
      suggestions.push({ id: 'review_summary', label: 'è¯„ä»·åˆ†æ', icon: ThumbsUp, color: 'text-amber-600' });
      suggestions.push({ id: 'compare', label: 'ç«å“å¯¹æ¯”', icon: Scale, color: 'text-blue-600' });
      break;
    case 'code':
      suggestions.push({ id: 'explain', label: 'ä»£ç è§£è¯»', icon: Code, color: 'text-amber-600' });
      suggestions.push({ id: 'debug', label: 'æŸ¥æ‰¾ Bug', icon: Bug, color: 'text-red-600' });
      suggestions.push({ id: 'refactor', label: 'é‡æ„ä¼˜åŒ–', icon: Zap, color: 'text-purple-600' });
      break;
    case 'video':
      suggestions.push({ id: 'summary_video', label: 'è§†é¢‘æ‘˜è¦', icon: ListVideo, color: 'text-red-600' });
      suggestions.push({ id: 'highlights', label: 'æå–é‡‘å¥', icon: Star, color: 'text-yellow-600' });
      suggestions.push({ id: 'ask_video', label: 'ç›¸å…³é—®ç­”', icon: MessageSquare, color: 'text-blue-600' });
      break;
    case 'finance':
      suggestions.push({ id: 'predict', label: 'è¶‹åŠ¿é¢„æµ‹', icon: TrendingUp, color: 'text-emerald-600' });
      suggestions.push({ id: 'risk', label: 'é£é™©è¯„ä¼°', icon: AlertTriangle, color: 'text-rose-600' });
      suggestions.push({ id: 'fundamentals', label: 'åŸºæœ¬é¢', icon: Activity, color: 'text-blue-600' });
      break;
    case 'design':
      suggestions.push({ id: 'summary', label: 'è®¾è®¡å“²å­¦', icon: Lightbulb, color: 'text-indigo-600' });
      suggestions.push({ id: 'share', label: 'åˆ†äº«å¡ç‰‡', icon: Share, color: 'text-purple-600' });
      suggestions.push({ id: 'quiz', label: 'ç†å¿µæµ‹éªŒ', icon: CheckCircle2, color: 'text-blue-600' });
      break;
    default:
      suggestions.push({ id: 'summary', label: 'æ™ºèƒ½æ‘˜è¦', icon: FileText, color: 'text-blue-600' });
      suggestions.push({ id: 'translate', label: 'å…¨æ–‡ç¿»è¯‘', icon: Globe, color: 'text-green-600' });
      break;
  }
  return suggestions.slice(0, 3);
};

// --- 3. å­ç»„ä»¶ï¼šé¡µé¢å†…å®¹ ---
const PageContent = ({ type }) => {
  if (type === 'video') return (
    <div className="max-w-7xl mx-auto pt-6 px-6 animate-fade-in-up pb-20">
      <div className="grid grid-cols-12 gap-6">
        <div className="col-span-8 space-y-4">
           <div className="aspect-video bg-black rounded-xl relative group overflow-hidden shadow-lg">
              <div className="absolute inset-0 flex items-center justify-center">
                 <div className="w-16 h-16 rounded-full bg-red-600/90 flex items-center justify-center cursor-pointer group-hover:scale-110 transition-transform">
                    <Play size={32} fill="white" className="text-white ml-1" />
                 </div>
              </div>
              <div className="absolute bottom-4 left-4 right-4">
                 <div className="w-full h-1 bg-gray-600 rounded-full mb-2">
                    <div className="w-1/3 h-full bg-red-600 rounded-full relative">
                       <div className="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-red-600 rounded-full scale-0 group-hover:scale-100 transition-transform"></div>
                    </div>
                 </div>
                 <div className="flex justify-between text-white text-xs font-medium">
                    <span>04:20 / 12:45</span>
                    <div className="flex gap-3">
                       <Subtitles size={16} />
                       <Settings size={16} />
                       <Maximize size={16} />
                    </div>
                 </div>
              </div>
           </div>
           
           <div className="space-y-3">
              <h1 className="text-xl font-bold text-gray-900">AI æµè§ˆå™¨çš„æœªæ¥ï¼šæµä½“æ™ºèƒ½ä¸æ„å›¾äº¤äº’</h1>
              <div className="flex items-center justify-between border-b border-gray-100 pb-4">
                 <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold">D</div>
                    <div>
                       <div className="text-sm font-bold text-gray-900">DesignDaily</div>
                       <div className="text-xs text-gray-500">45ä¸‡ è®¢é˜…è€…</div>
                    </div>
                    <button className="ml-4 px-4 py-2 bg-black text-white text-sm font-medium rounded-full hover:bg-gray-800">è®¢é˜…</button>
                 </div>
              </div>
           </div>
        </div>
        <div className="col-span-4 space-y-4">
           {[1, 2, 3].map(i => (
              <div key={i} className="flex gap-2 cursor-pointer group">
                 <div className="w-32 h-20 bg-gray-200 rounded-lg flex-shrink-0 relative overflow-hidden"><div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div></div>
                 <div className="flex-1">
                    <h3 className="text-sm font-semibold text-gray-900 line-clamp-2 leading-tight group-hover:text-blue-600">ç”Ÿæˆå¼ UI çš„è®¾è®¡æ¨¡å¼</h3>
                    <div className="text-xs text-gray-500 mt-1">TechInsider</div>
                 </div>
              </div>
           ))}
        </div>
      </div>
    </div>
  );

  if (type === 'design') return (
    <div className="max-w-5xl mx-auto pt-16 px-12 animate-fade-in-up pb-24">
      <div className="text-center mb-20 space-y-8">
         <div className="inline-flex items-center gap-2 px-4 py-1.5 bg-gray-100 rounded-full text-xs font-bold text-gray-600 uppercase border border-gray-200">
            <Sparkles size={12} className="text-blue-600" /> The Manifesto
         </div>
         <h1 className="text-6xl font-black text-gray-900 tracking-tight leading-none">
           æµä½“æ™ºèƒ½<br/>
           <span className="text-gray-400">Liquid Intelligence</span>
         </h1>
         <p className="text-xl text-gray-500 max-w-2xl mx-auto font-normal leading-relaxed">
           ç•Œé¢åº”å¦‚æ°´èˆ¬éšå½¢ã€‚æœ€å¥½çš„äº¤äº’ä¸æ˜¯ç‚¹å‡»ï¼Œè€Œæ˜¯æ„å›¾çš„è‡ªç„¶æµéœ²ã€‚
         </p>
      </div>
      <div className="grid grid-cols-3 gap-8">
        {[
          { icon: Layers, title: "æ— å½¢ä¹‹å½¢", desc: "ç•Œé¢ä»…åœ¨éœ€è¦æ—¶æ˜¾ç°ï¼Œå¦‚å‘¼å¸èˆ¬è‡ªç„¶ã€‚", theme: "indigo" },
          { icon: Zap, title: "æ„å›¾ä¼˜å…ˆ", desc: "ä»å¯»æ‰¾å˜ä¸ºè¾¾æˆï¼Œç»“æœä¸»åŠ¨æµå‘ç”¨æˆ·ã€‚", theme: "purple" },
          { icon: Cpu, title: "æƒ…å¢ƒæ„ŸçŸ¥", desc: "åƒå‰¯é©¾é©¶ä¸€æ ·ï¼Œç†è§£ä½ æ­£åœ¨çœ‹ä»€ä¹ˆã€‚", theme: "emerald" }
        ].map((card, i) => (
          <div key={i} className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
             <div className={`w-12 h-12 rounded-xl flex items-center justify-center mb-6 ${CONTENT_COLORS[card.theme]}`}>
                <card.icon size={24} />
             </div>
             <h3 className="text-xl font-bold text-gray-900 mb-2">{card.title}</h3>
             <p className="text-sm text-gray-500 leading-relaxed">{card.desc}</p>
          </div>
        ))}
      </div>
      
      {/* çŠ¶æ€å²›è®¾è®¡å±•ç¤ºåŒº */}
      <div className="border-t border-gray-100 pt-20 mt-20">
        <div className="text-center mb-16">
           <h2 className="text-3xl font-bold text-gray-900 mb-4">çŠ¶æ€å²›è®¾è®¡ç³»ç»Ÿ</h2>
           <p className="text-gray-500">The Status Island System</p>
        </div>

        <div className="space-y-12">
           {/* State 1: Processing */}
           <div className="flex items-center gap-12">
              <div className="w-1/3 text-right space-y-2">
                 <h3 className="text-lg font-bold text-gray-900">01. æ„ŸçŸ¥ä¸ç†è§£</h3>
                 <p className="text-sm text-gray-500">å½“é¡µé¢åŠ è½½æ—¶ï¼ŒçŠ¶æ€å²›è‡ªåŠ¨å±•å¼€ï¼Œé€šè¿‡è“è‰²æ—‹è½¬å…‰æ•ˆç¤ºæ„ AI æ­£åœ¨é˜…è¯»å¹¶æå–å…³é”®ä¿¡æ¯ã€‚</p>
              </div>
              <div className="flex-1 bg-gray-50 rounded-2xl p-8 border border-gray-100 flex items-center justify-center">
                 <div className="bg-white rounded-full px-4 py-2 flex items-center gap-3 shadow-sm border border-blue-100">
                    <RotateCw size={16} className="text-blue-600 animate-spin" />
                    <span className="text-xs font-medium text-gray-600">æ­£åœ¨åˆ†æé¡µé¢...</span>
                 </div>
              </div>
           </div>

           {/* State 2: Ready */}
           <div className="flex items-center gap-12 flex-row-reverse">
              <div className="w-1/3 text-left space-y-2">
                 <h3 className="text-lg font-bold text-gray-900">02. å»ºè®®å°±ç»ª</h3>
                 <p className="text-sm text-gray-500">åˆ†æå®Œæˆåï¼Œæ”¶ç¼©ä¸ºé™é»˜å›¾æ ‡ã€‚å½“ç”¨æˆ·é¼ æ ‡æ‚¬åœæ—¶ï¼Œæµç•…æ»‘å‡ºåŸºäºå½“å‰åœºæ™¯çš„æ ¸å¿ƒæ“ä½œå»ºè®®ã€‚</p>
              </div>
              <div className="flex-1 bg-gray-50 rounded-2xl p-8 border border-gray-100 flex items-center justify-center relative">
                 <div className="bg-white rounded-full pl-1 pr-1 py-1 flex items-center gap-2 shadow-lg border border-gray-100">
                    <div className="w-7 h-7 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                       <Sparkles size={14} fill="currentColor" />
                    </div>
                    <div className="flex gap-1 pr-1">
                       <span className="px-3 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-600">è®¾è®¡å“²å­¦</span>
                       <span className="px-3 py-1 bg-white hover:bg-gray-50 rounded-full text-xs font-medium text-gray-600 border border-gray-100">åˆ†äº«å¡ç‰‡</span>
                    </div>
                 </div>
              </div>
           </div>
        </div>
      </div>
    </div>
  );
  
  if (type === 'shopping') return (
    <div className="max-w-6xl mx-auto pt-6 px-6 animate-fade-in-up pb-20">
      <div className="grid grid-cols-12 gap-8 bg-white p-8 rounded-2xl shadow-sm border border-gray-100 min-h-[600px]">
        <div className="col-span-5 space-y-4">
           <div className="aspect-square bg-[#F8F8F8] rounded-xl flex items-center justify-center relative overflow-hidden group">
              <img src="https://images.unsplash.com/photo-1505740420928-5e560c06d30e?q=80&w=1000&auto=format&fit=crop" alt="Headphones" className="relative z-10 w-3/4 mix-blend-multiply transition-transform duration-500 group-hover:scale-105"/>
           </div>
        </div>
        <div className="col-span-7 space-y-6">
           <div>
             <h1 className="text-3xl font-bold text-gray-900 leading-tight">Sony WH-1000XM5 æ— çº¿é™å™ªè€³æœº (é»‘è‰²)</h1>
             <div className="flex gap-1 text-yellow-400 text-sm items-center mt-2">
               <span>â˜…</span><span>â˜…</span><span>â˜…</span><span>â˜…</span><span className="text-gray-300">â˜…</span>
               <span className="text-gray-500 ml-1 text-xs">(4,281 æ¡è¯„ä»·)</span>
             </div>
           </div>
           <div className="border-t border-b border-gray-100 py-6">
              <div className="flex items-baseline gap-3">
                 <span className="text-4xl font-bold text-rose-600">Â¥ 2,499</span>
                 <span className="text-lg text-gray-400 line-through">Â¥ 2,899</span>
              </div>
           </div>
           <div className="pt-4 flex gap-4">
              <button className="flex-1 bg-black text-white py-4 rounded-xl font-bold hover:bg-gray-800 transition-colors flex items-center justify-center gap-2">
                 åŠ å…¥è´­ç‰©è½¦ <ShoppingCart size={18}/>
              </button>
           </div>
        </div>
      </div>
    </div>
  );

  if (type === 'finance') return (
    <div className="max-w-7xl mx-auto pt-6 px-6 animate-fade-in-up pb-20">
      <div className="grid grid-cols-12 gap-6">
        <div className="col-span-8 bg-white rounded-2xl p-8 shadow-sm border border-gray-100 h-[600px] flex flex-col">
           <div className="flex justify-between items-start mb-8">
             <div>
               <div className="flex items-center gap-2 mb-1">
                 <h2 className="text-4xl font-bold text-gray-900 leading-none">NVDA</h2>
                 <span className="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs font-bold">çº³æ–¯è¾¾å…‹</span>
               </div>
               <span className="text-sm text-gray-500 font-medium">è‹±ä¼Ÿè¾¾ (NVIDIA Corporation)</span>
             </div>
             <div className="text-right">
                <div className="text-5xl font-bold text-gray-900 tracking-tight">924.00</div>
                <div className="text-lg font-medium text-emerald-600 flex items-center justify-end gap-1 mt-2">
                  +24.50 (2.72%) <TrendingUp size={20} />
                </div>
             </div>
           </div>
           <div className="flex-1 bg-white relative w-full flex items-end justify-between gap-1 border-b border-gray-200 pb-6 overflow-hidden">
             {[40, 45, 42, 55, 60, 58, 65, 70, 75, 72, 80, 85, 82, 90, 95, 88, 92, 98, 94, 100].map((h, i) => (
                <div key={i} className="flex-1 bg-emerald-500 hover:bg-emerald-400 transition-colors rounded-t-sm relative group" style={{height: `${h}%`}}></div>
             ))}
           </div>
        </div>
        <div className="col-span-4 space-y-6">
           <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
              <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                <Activity size={16} className="text-blue-500"/> å¸‚åœºæƒ…ç»ª
              </h3>
              <div className="flex items-center gap-4">
                 <div className="w-20 h-20 rounded-full border-[6px] border-emerald-500 flex items-center justify-center text-emerald-600 font-bold text-2xl relative">
                    92
                 </div>
                 <div>
                    <div className="text-lg font-bold text-gray-900">æåº¦è´ªå©ª</div>
                 </div>
              </div>
           </div>
        </div>
      </div>
    </div>
  );

  if (type === 'code') return (
    <div className="max-w-7xl mx-auto pt-6 px-6 animate-fade-in-up pb-20 h-full">
      <div className="bg-[#1e1e1e] rounded-xl overflow-hidden shadow-2xl border border-white/10 ring-1 ring-black/5 font-mono text-sm h-[600px] flex flex-col">
        <div className="bg-[#252526] flex items-center text-gray-400 select-none">
          <div className="flex items-center gap-2 px-4 py-2.5 bg-[#1e1e1e] border-t-2 border-blue-500 text-gray-100">
            <Code size={14} className="text-blue-400"/>
            <span>payment_logic.ts</span>
            <X size={12} className="ml-2 hover:bg-white/10 rounded p-0.5"/>
          </div>
        </div>
        <div className="flex-1 flex overflow-hidden">
           <div className="w-12 bg-[#1e1e1e] text-gray-600 text-right pr-3 pt-4 select-none leading-relaxed border-r border-white/5">
              {Array.from({length: 20}).map((_, i) => <div key={i}>{i+1}</div>)}
           </div>
           <div className="flex-1 p-4 overflow-auto bg-[#1e1e1e] text-gray-300">
            <pre className="leading-relaxed font-mono">
              <span className="text-purple-400">export const</span> <span className="text-yellow-200">processTx</span> = <span className="text-purple-400">async</span> (tx: Transaction) <span className="text-purple-400">{`=>`}</span> {'{'}<br/>
              &nbsp;&nbsp;<span className="text-blue-400">console</span>.log(<span className="text-orange-300">`æ­£åœ¨å¤„ç†äº¤æ˜“...`</span>);<br/>
              {'}'}
            </pre>
           </div>
        </div>
      </div>
    </div>
  );

  return <div className="flex items-center justify-center h-full text-gray-400 font-light text-xl">ğŸ“„ é€šç”¨æµè§ˆæ¨¡å¼</div>;
};

// Helper for Code view
const GitBranchIcon = ({size}) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="6" y1="3" x2="6" y2="15"></line><circle cx="18" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><path d="M18 9a9 9 0 0 1-9 9"></path></svg>
);

// --- 4. å­ç»„ä»¶ï¼šä¾§è¾¹æ  ---
const SidePanel = ({ open, onClose, chatHistory, onNewMessage, activeTab }) => {
  const [activePanel, setActivePanel] = useState('chat'); 
  const theme = (activeTab && THEME_STYLES[activeTab.theme]) || THEME_STYLES.indigo;

  if (!activeTab) return null;

  return (
    <div 
      className={`
        absolute top-4 bottom-4 right-4 w-[380px] 
        bg-white/95 backdrop-blur-xl rounded-xl
        shadow-[0_8px_30px_rgba(0,0,0,0.12)] 
        border border-gray-200 z-40 flex flex-col overflow-hidden
        transition-all duration-300 cubic-bezier(0.19, 1, 0.22, 1) origin-top-right
        ${open ? 'opacity-100 scale-100 translate-x-0' : 'opacity-0 scale-95 pointer-events-none translate-x-4'}
      `}
    >
      {/* Header */}
      <div className="h-14 flex items-center justify-between px-4 border-b border-gray-100">
        <div className="flex items-center gap-2 text-gray-700">
          <Sparkles size={16} className="text-blue-600" />
          <span className="font-medium text-sm">AI åŠ©æ‰‹</span>
        </div>
        <div className="flex bg-gray-100 p-0.5 rounded-lg">
          {['chat', 'tools'].map(tab => (
            <button
              key={tab}
              onClick={() => setActivePanel(tab)}
              className={`
                px-3 py-1 rounded-md text-xs font-medium capitalize transition-all
                ${activePanel === tab ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}
              `}
            >
              {tab === 'chat' ? 'å¯¹è¯' : 'å·¥å…·'}
            </button>
          ))}
        </div>
        <button onClick={onClose} className="p-1.5 hover:bg-gray-100 rounded-full text-gray-400 transition-colors">
          <X size={14} />
        </button>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto custom-scrollbar p-4 bg-gray-50/50">
        
        {/* PANEL: TOOLS */}
        {activePanel === 'tools' && (
          <div className="space-y-6 animate-fade-in-up">
            <div className="space-y-3">
              <h3 className="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">é¡µé¢æ“ä½œ</h3>
              <div className="grid grid-cols-2 gap-3">
                 <button className="flex flex-col items-center justify-center p-3 bg-white rounded-xl border border-gray-100 hover:border-gray-300 transition-all shadow-sm hover:shadow-md group">
                    <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center text-blue-500 mb-2 group-hover:scale-110 transition-transform">
                       <FileText size={16} />
                    </div>
                    <span className="text-xs font-medium text-gray-700">ç”Ÿæˆæ‘˜è¦</span>
                 </button>
                 <button className="flex flex-col items-center justify-center p-3 bg-white rounded-xl border border-gray-100 hover:border-gray-300 transition-all shadow-sm hover:shadow-md group">
                    <div className="w-8 h-8 bg-purple-50 rounded-lg flex items-center justify-center text-purple-500 mb-2 group-hover:scale-110 transition-transform">
                       <Wand2 size={16} />
                    </div>
                    <span className="text-xs font-medium text-gray-700">æ™ºèƒ½æ¶¦è‰²</span>
                 </button>
              </div>
            </div>

            <div className="space-y-3">
              <h3 className="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">æ´å¯Ÿ</h3>
              <div className="bg-white rounded-xl border border-gray-100 p-4 shadow-sm space-y-3">
                 <div className="flex justify-between items-center">
                    <span className="text-xs font-semibold text-gray-600">å¯ä¿¡åº¦è¯„åˆ†</span>
                    <span className="text-green-600 font-bold text-xs">98/100</span>
                 </div>
                 <div className="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                    <div className="bg-gradient-to-r from-green-400 to-emerald-500 w-[98%] h-full rounded-full"></div>
                 </div>
                 <div className="pt-1 flex gap-1.5 flex-wrap">
                    {['#è®¾è®¡', '#UI/UX', '#è¶‹åŠ¿'].map(tag => (
                      <span key={tag} className="px-2 py-0.5 bg-gray-50 text-gray-500 text-[10px] font-medium rounded border border-gray-100">{tag}</span>
                    ))}
                 </div>
              </div>
            </div>
          </div>
        )}

        {/* PANEL: CHAT */}
        {activePanel === 'chat' && (
          <div className="flex flex-col h-full animate-fade-in-up">
             <div className="flex-1 space-y-4 pb-4">
                {chatHistory.map(msg => (
                  <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : ''}`}>
                     <div className={`
                       max-w-[95%] p-0 rounded-2xl text-sm leading-relaxed shadow-sm
                       ${msg.role === 'user' ? 'bg-[#0b57d0] text-white p-3 rounded-br-none' : 'bg-transparent shadow-none'}
                     `}>
                       {/* ä¿®å¤ï¼šä½¿ç”¨åŠ¨æ€é¢œè‰²æ¸²æŸ“å›¾æ ‡ */}
                       {msg.type === 'result' && msg.action ? (
                          <div className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm animate-in fade-in zoom-in-95 duration-200">
                             <div className="px-3 py-2 border-b border-gray-100 bg-gray-50/50 flex items-center gap-2">
                                <div className={`p-1 rounded ${msg.action.color ? msg.action.color.replace('text-', 'bg-').replace('600', '100') : 'bg-gray-100'}`}>
                                  {msg.action.icon && React.createElement(msg.action.icon, { size: 12, className: msg.action.color })}
                                </div>
                                <span className="text-xs font-semibold text-gray-700">{msg.action.label}</span>
                             </div>
                             <div className="p-3">
                                <p className="text-sm text-gray-600 mb-3">{msg.content}</p>
                                {/* å®šåˆ¶åŒ– UI æ¸²æŸ“åŒº (Optional) */}
                                {msg.action.id === 'price_check' && (
                                   <div className="space-y-2">
                                      <div className="flex justify-between items-center p-2 rounded bg-green-50 border border-green-100">
                                         <span className="text-xs font-medium text-green-800">äº¬ä¸œè‡ªè¥ (å½“å‰)</span>
                                         <span className="text-xs font-bold text-green-700">Â¥ 2,499</span>
                                      </div>
                                      <div className="flex justify-between items-center p-2 rounded bg-gray-50 border border-gray-100">
                                         <span className="text-xs text-gray-600">å¤©çŒ«æ——èˆ°åº—</span>
                                         <span className="text-xs text-gray-500">Â¥ 2,549</span>
                                      </div>
                                   </div>
                                )}

                                {msg.action.id === 'review_summary' && (
                                   <div className="space-y-2">
                                      <div className="flex items-start gap-2">
                                         <ThumbsUp size={12} className="text-green-500 mt-1 shrink-0"/>
                                         <span className="text-xs text-gray-600">éŸ³è´¨é€šé€ï¼Œé™å™ªæ•ˆæœæ˜æ˜¾ä¼˜äºä¸Šä¸€ä»£ã€‚</span>
                                      </div>
                                      <div className="flex items-start gap-2">
                                         <ThumbsDown size={12} className="text-rose-500 mt-1 shrink-0"/>
                                         <span className="text-xs text-gray-600">è€³ç½©æè´¨è¾ƒçƒ­ï¼Œå¤å¤©ä½©æˆ´ä¸é€‚ã€‚</span>
                                      </div>
                                   </div>
                                )}

                                {(msg.action.id === 'explain' || msg.action.id === 'code') && (
                                   <div className="bg-[#1e1e1e] p-2 rounded-lg font-mono text-[10px] text-gray-300 overflow-x-auto">
                                      <span className="text-purple-400">if</span> (tx.amount &lt;= 0) <span className="text-yellow-300">throw</span> Error;
                                   </div>
                                )}
                             </div>
                             <div className="flex border-t border-gray-100">
                                <button className="flex-1 py-2 text-xs text-gray-500 hover:bg-gray-50 transition-colors">å¤åˆ¶</button>
                                <div className="w-px bg-gray-100"></div>
                                <button className="flex-1 py-2 text-xs text-gray-500 hover:bg-gray-50 transition-colors">æ·±å…¥åˆ†æ</button>
                             </div>
                          </div>
                       ) : (
                          msg.role === 'ai' ? (
                             <div className="bg-white p-3 rounded-xl rounded-tl-none border border-gray-200 shadow-sm text-gray-700">
                                {typeof msg.content === 'string' ? msg.content : ''}
                             </div>
                          ) : (
                             typeof msg.content === 'string' ? msg.content : ''
                          )
                       )}
                     </div>
                  </div>
                ))}
             </div>
             <div className="relative mt-auto">
               <input 
                 className="w-full bg-white border border-gray-200 rounded-full px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all placeholder:text-gray-400 shadow-sm"
                 placeholder="è¾“å…¥é—®é¢˜..."
                 onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      if (onNewMessage) onNewMessage(e.target.value);
                      e.target.value = '';
                    }
                 }}
               />
               <button className="absolute right-2 top-1.5 p-1 bg-blue-600 rounded-full text-white hover:bg-blue-700 transition-colors">
                 <ArrowRight size={14} />
               </button>
             </div>
          </div>
        )}
      </div>
    </div>
  );
};

// --- 5. ä¸»åº”ç”¨ç»„ä»¶ ---
export default function AiBrowserInterface() {
  const [tabs, setTabs] = useState(INITIAL_TABS);
  const [activeTabId, setActiveTabId] = useState('tab-5');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [islandState, setIslandState] = useState('idle');
  const [isPinned, setIsPinned] = useState(false);
  const [dynamicActions, setDynamicActions] = useState([]);
  const [chatHistory, setChatHistory] = useState([{ id: 1, role: 'system', content: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½æµè§ˆåŠ©æ‰‹ã€‚' }]);

  const activeTab = tabs.find(t => t.id === activeTabId) || tabs[0];
  const theme = (activeTab && THEME_STYLES[activeTab.theme]) || THEME_STYLES.indigo;

  // 1. å®šä¹‰äº‹ä»¶å¤„ç†å‡½æ•°
  const handleAction = (action) => {
    setSidebarOpen(true);
    setIslandState('idle'); // ç«‹å³æ”¶èµ·
    let responseText = `æ­£åœ¨ä¸ºæ‚¨åˆ†æ"${action.label}"...`;
    
    // ç®€å•çš„æ¨¡æ‹Ÿæ–‡æ¡ˆ
    if (action.id === 'price_check') responseText = "å·²å®Œæˆå…¨ç½‘æ¯”ä»·ã€‚äº¬ä¸œè‡ªè¥å½“å‰ä»·æ ¼æœ€ä¼˜ï¼Œå»ºè®®å…¥æ‰‹ã€‚";
    if (action.id === 'review_summary') responseText = "åŸºäº 4000+ æ¡è¯„è®ºåˆ†æï¼šå¥½è¯„ç‡ 96%ã€‚ä¸»è¦ä¼˜ç‚¹æ˜¯é™å™ªå’ŒéŸ³è´¨ï¼Œç¼ºç‚¹æ˜¯é€æ°”æ€§ã€‚";
    if (action.id === 'explain') responseText = "è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªæ”¯ä»˜å¤„ç†å‡½æ•°ï¼ŒåŒ…å«åŸºæœ¬çš„å‚æ•°æ ¡éªŒå’Œå¼‚æ­¥è°ƒç”¨ã€‚";
    if (action.id === 'predict') responseText = "åŸºäºæŠ€æœ¯æŒ‡æ ‡åˆ†æï¼Œè¯¥è‚¡ç¥¨çŸ­æœŸå‘ˆä¸Šæ¶¨è¶‹åŠ¿ (Bullish)ã€‚";
    if (action.id === 'summary_video') responseText = "è§†é¢‘æ ¸å¿ƒè§‚ç‚¹ï¼š\n1. AI æ”¹å˜äº¤äº’èŒƒå¼\n2. åŸç”Ÿèåˆæ˜¯æœªæ¥è¶‹åŠ¿";

    setChatHistory(prev => [...prev, {
      id: Date.now(),
      role: 'ai',
      type: 'result',
      action: action,
      content: responseText
    }]);
  };

  const handleNewMessage = (text) => {
    setChatHistory(prev => [...prev, { id: Date.now(), role: 'user', content: text }]);
    setTimeout(() => {
      setChatHistory(prev => [...prev, { 
        id: Date.now() + 1, 
        role: 'ai', 
        type: 'text', 
        content: 'æˆ‘æ˜ç™½äº†ã€‚åŸºäºå½“å‰é¡µé¢å†…å®¹ï¼Œæˆ‘ä¸ºæ‚¨æ‰¾åˆ°ä»¥ä¸‹ä¿¡æ¯...' 
      }]);
    }, getRandomDelay());
  };

  // 2. å‰¯ä½œç”¨ï¼šæ¨¡æ‹Ÿé¡µé¢å†…å®¹åˆ†æ
  useEffect(() => {
    setIslandState('analyzing');
    const timer = setTimeout(() => {
      const newActions = getAiSuggestions({ type: activeTab.type, text: activeTab.title + activeTab.type });
      setDynamicActions(newActions);
      setIslandState('idle');
    }, getRandomDelay());
    return () => clearTimeout(timer);
  }, [activeTabId]);

  const isExpanded = islandState === 'hover' || isPinned || islandState === 'suggestion';

  return (
    <div className="flex flex-col h-screen overflow-hidden font-sans text-[#3c4043] bg-white">
      
      {/* 1. å›ºå®šé¡¶éƒ¨å¯¼èˆª */}
      <div className={`${CHROME_COLORS.frame} pt-2 px-1.5 flex flex-col z-50 relative shrink-0`}>
           
           {/* Tab Bar */}
           <div className="flex items-end gap-1 px-1 select-none overflow-hidden h-[34px]">
              <div className="flex gap-2 px-3 items-center h-full pb-1 mr-2">
                <div className="w-3 h-3 rounded-full bg-[#FF5F57] border border-[#E0443E]"></div>
                <div className="w-3 h-3 rounded-full bg-[#FEBC2E] border border-[#D89E24]"></div>
                <div className="w-3 h-3 rounded-full bg-[#28C840] border border-[#1AAB29]"></div>
              </div>

              {tabs.map((tab, idx) => {
                const isActive = tab.id === activeTabId;
                return (
                  <div key={tab.id} className="relative flex-1 max-w-[240px] min-w-[120px] h-full group">
                    {!isActive && idx > 0 && tabs[idx-1].id !== activeTabId && (
                      <div className="absolute left-0 top-1.5 bottom-1.5 w-[1px] bg-[#80868b] opacity-40"></div>
                    )}
                    <div 
                      onClick={() => setActiveTabId(tab.id)}
                      className={`
                        absolute inset-0 rounded-t-lg transition-all duration-100 flex items-center px-3 cursor-default
                        ${isActive ? 'bg-white shadow-[0_0_4px_rgba(0,0,0,0.1)] z-10' : 'hover:bg-[#e7eaed]'}
                      `}
                    >
                      <div className="flex items-center gap-2 w-full">
                        <tab.icon size={14} className={isActive ? 'text-blue-600' : 'text-[#5f6368]'} />
                        <span className={`text-xs truncate flex-1 ${isActive ? 'text-[#3c4043] font-medium' : 'text-[#5f6368]'}`}>
                          {tab.title}
                        </span>
                        <button className={`p-0.5 rounded-full hover:bg-[#e8eaed] ${isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>
                          <X size={10} />
                        </button>
                      </div>
                    </div>
                    {isActive && (
                      <>
                        <div className="absolute bottom-0 -left-2 w-2 h-2">
                          <svg width="100%" height="100%" viewBox="0 0 8 8" fill="none"><path d="M8 8H0C4.41828 8 8 4.41828 8 0V8Z" fill="white"/></svg>
                        </div>
                        <div className="absolute bottom-0 -right-2 w-2 h-2">
                          <svg width="100%" height="100%" viewBox="0 0 8 8" fill="none"><path d="M0 8H8C3.58172 8 0 4.41828 0 0V8Z" fill="white"/></svg>
                        </div>
                      </>
                    )}
                  </div>
                )
              })}
              <button className="p-1.5 ml-1 rounded-full hover:bg-[#cfd2d6] text-[#3c4043] transition-colors"><Plus size={18} /></button>
           </div>

           {/* Toolbar & Omnibox */}
           <div className="bg-white py-1.5 px-3 flex items-center gap-2 shadow-sm relative z-20">
              <div className="flex gap-1 text-[#5f6368]">
                 <button className="p-1.5 rounded-full hover:bg-[#f1f3f4] transition-colors disabled:opacity-30"><ArrowRight className="rotate-180" size={18} /></button>
                 <button className="p-1.5 rounded-full hover:bg-[#f1f3f4] transition-colors disabled:opacity-30"><ArrowRight size={18} /></button>
                 <button className="p-1.5 rounded-full hover:bg-[#f1f3f4] transition-colors"><RotateCw size={16} /></button>
                 <button className="p-1.5 rounded-full hover:bg-[#f1f3f4] transition-colors ml-1"><Home size={16} /></button>
              </div>

              {/* INTELLIGENT OMNIBOX */}
              <div className="flex-1 relative h-8 group/omnibox">
                 <div className={`absolute inset-0 bg-[#f1f3f4] border border-transparent group-focus-within/omnibox:bg-white group-focus-within/omnibox:border-blue-500/30 group-focus-within/omnibox:shadow-[0_1px_3px_rgba(0,0,0,0.1)] rounded-full transition-all duration-200 flex items-center pl-3 pr-1`}>
                    <div className="mr-2 p-1 hover:bg-[#e0e3e7] rounded-full cursor-pointer"><Lock size={12} className="text-[#5f6368]" /></div>
                    <div className="flex-1 text-[13px] truncate text-[#202124] selection:bg-[#b3d7ff]">
                       <span className="text-black">{activeTab.url.split('/')[0]}</span>
                       <span className="text-[#5f6368]">/{activeTab.url.split('/').slice(1).join('/')}</span>
                    </div>

                    {/* AI STATUS ISLAND - BLUE LIGHT */}
                    <div 
                      className="relative my-auto flex items-center justify-end transition-all duration-500 cubic-bezier(0.19, 1, 0.22, 1) mr-1"
                      onMouseEnter={() => (islandState === 'idle' || islandState === 'suggestion') && setIslandState('hover')}
                      onMouseLeave={() => islandState === 'hover' && setIslandState('idle')}
                    >
                      <div className={`flex items-center h-[26px] rounded-full transition-all duration-300 ${isExpanded ? 'bg-white border border-gray-200 px-1 ml-2 shadow-sm' : 'bg-transparent'}`}>
                        {/* 1. Main Icon */}
                        <div 
                           className={`w-6 h-6 rounded-full flex-shrink-0 flex items-center justify-center transition-all cursor-pointer ${isExpanded ? 'text-blue-600' : 'text-[#5f6368] hover:bg-[#e0e3e7]'} ${islandState === 'analyzing' ? 'animate-pulse text-blue-600' : ''}`}
                           onClick={() => setSidebarOpen(!sidebarOpen)}
                        >
                           {islandState === 'analyzing' || islandState === 'thinking' ? (
                             <RotateCw size={14} className="animate-spin text-blue-500" />
                           ) : (
                             <Sparkles size={14} fill={isExpanded ? "currentColor" : "none"} />
                           )}
                        </div>

                        {/* 2. Expanded Content */}
                        <div className={`flex items-center overflow-hidden transition-all duration-300 ${isExpanded ? 'w-auto opacity-100 pl-1' : 'w-0 opacity-0'}`}>
                           
                           {/* çŠ¶æ€ A: ç†è§£ä¸­ */}
                           {islandState === 'analyzing' && (
                              <span className="text-[11px] font-medium text-blue-600 px-2 whitespace-nowrap animate-pulse">æ­£åœ¨ç†è§£é¡µé¢...</span>
                           )}

                           {/* çŠ¶æ€ B: ç”Ÿæˆä¸­ */}
                           {islandState === 'thinking' && (
                             <div className="flex items-center gap-2 px-2 whitespace-nowrap">
                               <span className="text-[11px] font-medium text-blue-600 animate-pulse">æ­£åœ¨ç”Ÿæˆ...</span>
                             </div>
                           )}

                           {/* çŠ¶æ€ C: å»ºè®®å±•ç¤º */}
                           {(islandState === 'hover' || isPinned || islandState === 'suggestion') && (
                             <div className="flex items-center gap-1.5 animate-slide-in-right">
                                {islandState === 'suggestion' && !isPinned && (
                                   <span className="text-[11px] font-medium text-blue-600 px-1 whitespace-nowrap animate-pulse">å·²ç”Ÿæˆ 3 ä¸ªå»ºè®®</span>
                                )}

                                {/* Hover æ—¶æ˜¾ç¤ºå…·ä½“æŒ‰é’® - ä½¿ç”¨ dynamic color æ¸²æŸ“å›¾æ ‡ */}
                                {(islandState === 'hover' || isPinned) && dynamicActions.map((action, idx) => (
                                  <button
                                    key={action.id}
                                    onClick={(e) => { e.stopPropagation(); handleAction(action); }}
                                    className={`
                                      flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[11px] font-medium
                                      bg-transparent hover:bg-gray-100 text-gray-600 hover:text-gray-900 
                                      transition-all duration-200 whitespace-nowrap
                                    `}
                                    style={{ animationDelay: `${idx * 100}ms`, animationFillMode: 'both' }}
                                  >
                                    <action.icon size={13} className={action.color} />
                                    <span>{action.label}</span>
                                  </button>
                                ))}
                             </div>
                           )}
                           
                           {/* Pin Button */}
                           {(islandState === 'hover' || isPinned) && (
                              <>
                                <div className="w-px h-3 bg-gray-200 mx-1"></div>
                                <button onClick={(e) => { e.stopPropagation(); setIsPinned(!isPinned); }} className={`p-1 rounded-full hover:bg-gray-100 transition-colors ${isPinned ? 'text-blue-600' : 'text-gray-400'}`}>
                                  {isPinned ? <Pin size={10} fill="currentColor"/> : <PinOff size={10} />}
                                </button>
                              </>
                           )}
                        </div>
                      </div>
                    </div>
                    
                    {/* Standard Right Icons */}
                    <div className="flex items-center gap-1 ml-1">
                       <button className="p-1.5 rounded-full hover:bg-[#e0e3e7] text-[#5f6368] transition-colors"><Star size={16} /></button>
                    </div>
                 </div>
              </div>

              <div className="flex items-center gap-1 text-[#5f6368] ml-1">
                 <button className="p-1.5 rounded-full hover:bg-[#f1f3f4] transition-colors"><Puzzle size={18} /></button>
                 <button onClick={() => setSidebarOpen(!sidebarOpen)} className={`p-1.5 rounded-full transition-colors ${sidebarOpen ? 'bg-blue-100 text-blue-600' : 'hover:bg-[#f1f3f4]'}`}><PanelRight size={18} /></button>
                 <div className="mx-1 h-4 w-px bg-gray-300"></div>
                 <button className="p-1 rounded-full hover:bg-[#f1f3f4] transition-colors"><div className="w-6 h-6 rounded-full bg-purple-600 flex items-center justify-center text-white text-xs font-bold">A</div></button>
                 <button className="p-1.5 rounded-full hover:bg-[#f1f3f4] transition-colors"><MoreVertical size={16} /></button>
              </div>
           </div>

           {/* 3. Bookmarks Bar */}
           <div className="bg-white px-3 pb-1.5 flex items-center gap-1 border-b border-gray-200 text-[11px] text-[#3c4043]">
              {BOOKMARKS.map((bm, i) => (
                <button key={i} className="flex items-center gap-1.5 px-2 py-1 rounded-full hover:bg-[#f1f3f4] transition-colors max-w-[120px] truncate">
                   {bm.icon ? <bm.icon size={12} className="text-[#5f6368]" /> : <div className="w-3 h-3 rounded-full bg-gray-300"></div>}
                   <span className="truncate">{bm.title}</span>
                </button>
              ))}
              <div className="flex-1"></div>
              <button className="p-1 rounded-full hover:bg-[#f1f3f4]"><ChevronRight size={12} className="text-[#5f6368]"/></button>
           </div>
        </div>

        {/* === 2. å†…å®¹åŒº (Content Wrapper) === */}
        <div className="flex-1 relative flex overflow-hidden bg-white">
            
            {/* é¡µé¢å†…å®¹ (Page Viewport) - ä¾§è¾¹æ æŒ¤å‹ */}
            <div className={`flex-1 h-full overflow-y-auto custom-scrollbar transition-all duration-300 ease-in-out ${sidebarOpen ? 'mr-[400px]' : 'mr-0'}`}>
               <PageContent type={activeTab.type} />
            </div>

            {/* ä¾§è¾¹æ  (Sidebar Container) - ç»å¯¹å®šä½ */}
            <div className={`absolute top-0 right-0 bottom-0 w-[400px] pointer-events-none ${sidebarOpen ? 'pointer-events-auto' : ''}`}>
               <SidePanel 
                  open={sidebarOpen} 
                  onClose={() => setSidebarOpen(false)} 
                  chatHistory={chatHistory} 
                  onNewMessage={handleNewMessage}
                  activeTab={activeTab}
               />
            </div>
        </div>
    </div>
  );
}